<?php $config="../../config.yaml";$lines=file($config);$pepper=trim($lines[30]);if($pepper==""){$lines[30]="     ".bin2hex(random_bytes(64))."\n";file_put_contents($config,implode($lines));echo("<meta http-equiv='refresh' content='0; http://".$_SERVER["HTTP_HOST"]."/PythonsWeb/'>");die("This is likely normal, just reload your page. If you keep seeing this, please contact us.");}require_once("../session.php");require_once("../setup_insec.php");if($_POST["loginOrRegister"]=="login"){$sql="SELECT salt from login WHERE username='".$_POST["login_username"]."'";$result=$conn_insec->query($sql);$count=mysqli_num_rows($result);if($count==0){$_SESSION["login_currentPerms"]="";echo("<meta http-equiv='refresh' content='3; http://".$_SESSION["login_path"]."'>");echo"Error: ".$sql."<br>".$conn_insec->error;die("<p style=\"color: red; position: absolute; top:1rem\">No account found with that login/password. Have another go?</p>");}else{$row=$result->fetch_assoc();$sql="SELECT username, password, perms FROM login WHERE username= '".$_POST["login_username"]."' and password='".hash("sha512",$row["salt"].$_POST["login_password"].$pepper)."' and perms='".$_SESSION["login_recPerms"]."'";$result=$conn_insec->query($sql);if($count==0){$_SESSION["login_currentPerms"]="";echo("<meta http-equiv='refresh' content='0; http://".$_SESSION["login_path"]."'>");echo"Error: ".$sql."<br>".$conn_insec->error;die("<p style=\"color: red; position: absolute; top:1rem\">No account found with that login/password. Have another go?</p>");}else{$_SESSION["login_currentPerms"]=$_SESSION["login_recPerms"];echo("<meta http-equiv='refresh' content='0; http://".$_SESSION["login_path"]."'>");}}$conn_insec->close();}else{$sql="SELECT username FROM login WHERE username = '".$_POST["login_username"]."'";$result=$conn_insec->query($sql);if(mysqli_num_rows($result)!=0){echo("<meta http-equiv='refresh' content='3; http://".$_SESSION["login_path"]."'>");die("<p style=\"color: red; position: absolute; top:1rem\">Another user has already taken this username.</p>");}$salt=bin2hex(random_bytes(8));$sql="INSERT INTO login (email, username, password, perms, salt) VALUES ('".$_POST["login_email"]."', '".$_POST["login_username"]."', '".hash("sha512",$pepper.$_POST["login_password"].$salt)."', 'user' , '$salt')";unset($salt);if($conn_insec->query($sql)===true){$conn_insec->close();$_SESSION["login_currentPerms"]="user";echo("<meta http-equiv='refresh' content='0; http://".$_SESSION["login_path"]."'>");echo "<p style=\"color: #63ebb0\"size=\"5rem\">New account created successfully.</p>";die(0);}else{$_SESSION["login_currentPerms"]="";echo("<meta http-equiv='refresh' content='3; http://".$_SESSION["login_path"]."'>");echo"Error: ".$sql."<br>".$conn_insec->error;die("<p style=\"color: red; position: absolute; top:1rem\">Login failed, have another go?</p>");}}